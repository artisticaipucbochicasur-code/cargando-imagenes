<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Luces ESP32</title>

<!-- Fuente + Iconos -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: linear-gradient(135deg, #222831, #393e46);
    --text: #fff;
    --accent: #00adb5;
    --success: #00e676;
    --error: #ff5252;
    --card: rgba(255,255,255,0.08);
    --shadow: rgba(0,0,0,0.3);
  }
  body.light {
    --bg: linear-gradient(135deg, #dfe9f3, #ffffff);
    --text: #222;
    --accent: #007bff;
    --success: #00c853;
    --error: #d32f2f;
    --card: rgba(255,255,255,0.6);
    --shadow: rgba(0,0,0,0.1);
  }

  body {
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
    background: var(--bg);
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    color: var(--text);
    transition: background 0.5s;
  }

  h1 {
    font-size: 26px;
    text-align: center;
    margin-top: 60px;
    text-shadow: 0 2px 6px var(--shadow);
  }

  /* Botón de Bluetooth */
  #connectBtn {
    background: var(--card);
    border: none;
    color: var(--accent);
    padding: 22px;
    border-radius: 50%;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 6px 20px var(--shadow);
    transition: all 0.3s;
    backdrop-filter: blur(10px);
  }
  #connectBtn.connected {
    background: var(--accent);
    color: white;
  }
  #connectBtn:active {
    transform: scale(0.95);
  }

  /* LEDs */
  .led-container {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 40px;
    margin-bottom: 80px;
  }

  .switch {
    width: 100px;
    height: 100px;
    background: var(--card);
    border-radius: 50%;
    box-shadow: 0 8px 25px var(--shadow);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  .switch i {
    font-size: 28px;
    margin-bottom: 6px;
  }
  .switch.on {
    background: var(--success);
    color: #fff;
    box-shadow: 0 0 25px var(--success);
  }
  .switch:active { transform: scale(0.95); }

  /* Toasts */
  #toastContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 9999;
  }
  .toast {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    color: #fff;
    padding: 12px 18px;
    border-radius: 12px;
    box-shadow: 0 5px 15px var(--shadow);
    animation: fadeInOut 3s forwards;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .toast.success { border-left: 5px solid var(--success); }
  .toast.error { border-left: 5px solid var(--error); }
  @keyframes fadeInOut {
    0% {opacity: 0; transform: translateY(-20px);}
    10%, 90% {opacity: 1; transform: translateY(0);}
    100% {opacity: 0; transform: translateY(-20px);}
  }

  /* Modal */
  #deviceModal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(8px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background: var(--card);
    border-radius: 20px;
    padding: 40px 30px;
    text-align: center;
    box-shadow: 0 10px 30px var(--shadow);
  }
  .modal-content h2 {
    margin-bottom: 25px;
  }
  .spinner {
    border: 5px solid rgba(255,255,255,0.2);
    border-top: 5px solid var(--accent);
    border-radius: 50%;
    width: 55px;
    height: 55px;
    margin: auto;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 100% {transform: rotate(360deg);} }

  /* Botón modo oscuro/claro */
  #themeToggle {
    position: absolute;
    top: 18px;
    right: 18px;
    background: var(--card);
    color: var(--text);
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 5px 15px var(--shadow);
    transition: all 0.3s;
  }
  #themeToggle:hover {
    transform: scale(1.1);
  }
</style>
</head>
<body>

  <button id="themeToggle"><i class="fa-solid fa-moon"></i></button>

  <h1><i class="fa-solid fa-lightbulb"></i><br>Luces ESP32</h1>

  <button id="connectBtn" onclick="toggleBluetooth()">
    <i class="fa-brands fa-bluetooth-b"></i>
  </button>

  <div class="led-container">
    <div id="led1" class="switch" onclick="toggleLed(1)">
      <i class="fa-solid fa-bolt"></i>
      <span>OFF</span>
    </div>
    <div id="led2" class="switch" onclick="toggleLed(2)">
      <i class="fa-solid fa-bolt"></i>
      <span>OFF</span>
    </div>
    <div id="led3" class="switch" onclick="toggleLed(3)">
      <i class="fa-solid fa-bolt"></i>
      <span>OFF</span>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastContainer"></div>

  <!-- Modal -->
  <div id="deviceModal">
    <div class="modal-content">
      <h2>Buscando dispositivos...</h2>
      <div class="spinner"></div>
    </div>
  </div>

<script>
let device, server, service, characteristic;
let leds = {1: false, 2: false, 3: false};
let connected = false;

// ✅ Toast moderno
function showToast(message, type="success") {
  const container = document.getElementById("toastContainer");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.innerHTML = `<i class="fa-solid ${type==="success"?"fa-circle-check":"fa-triangle-exclamation"}"></i>${message}`;
  container.appendChild(toast);
  setTimeout(()=>toast.remove(),3000);
}

// ✅ Conexión / Desconexión BLE
async function toggleBluetooth() {
  if (connected && device?.gatt.connected) {
    device.gatt.disconnect();
    showToast("Desconectado del ESP32","error");
    document.getElementById("connectBtn").classList.remove("connected");
    connected = false;
    return;
  }

  const modal = document.getElementById("deviceModal");
  modal.style.display = "flex";
  try {
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
    });
    server = await device.gatt.connect();
    service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
    characteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
    modal.style.display = "none";

    document.getElementById("connectBtn").classList.add("connected");
    connected = true;
    showToast("Conectado a " + device.name);

    device.addEventListener("gattserverdisconnected", () => {
      connected = false;
      document.getElementById("connectBtn").classList.remove("connected");
      showToast("Conexión perdida","error");
    });

  } catch (error) {
    modal.style.display = "none";
    showToast("Error o cancelado: " + error.message, "error");
  }
}

async function sendCommand(cmd) {
  if (!characteristic) {
    showToast("Conéctate primero al ESP32", "error");
    return;
  }
  try {
    const data = new TextEncoder().encode(cmd);
    await characteristic.writeValue(data);
  } catch (error) {
    showToast("Error al enviar comando", "error");
  }
}

function toggleLed(num) {
  leds[num] = !leds[num];
  const el = document.getElementById("led"+num);
  const icon = el.querySelector("i");
  const label = el.querySelector("span");
  el.classList.toggle("on");
  label.textContent = leds[num] ? "ON" : "OFF";
  icon.className = leds[num] ? "fa-solid fa-lightbulb" : "fa-solid fa-bolt";
  const cmd = leds[num] ? String.fromCharCode(64+num) : String.fromCharCode(96+num);
  sendCommand(cmd);
}

// ✅ Tema claro / oscuro
const themeToggle = document.getElementById("themeToggle");
themeToggle.addEventListener("click", ()=>{
  document.body.classList.toggle("light");
  const icon = themeToggle.querySelector("i");
  icon.className = document.body.classList.contains("light") ? "fa-solid fa-sun" : "fa-solid fa-moon";
});
</script>
</body>
</html>
