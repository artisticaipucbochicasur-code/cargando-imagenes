<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Luces ESP32</title>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(160deg, #74ebd5, #ACB6E5);
    color: #222;
    text-align: center;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin: 0;
  }

  h1 {
    font-size: 24px;
    margin-bottom: 20px;
  }

  .device-info {
    font-size: 14px;
    color: #444;
    margin-bottom: 10px;
  }

  button {
    border: none;
    background: #4e54c8;
    color: white;
    font-size: 18px;
    margin: 10px;
    padding: 15px 30px;
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: all 0.3s;
  }

  button:hover {
    transform: scale(1.05);
    background: #8f94fb;
  }

  .led-btn {
    width: 150px;
  }

  .on {
    background: #00c851 !important;
    box-shadow: 0 4px 10px rgba(0,200,81,0.4);
  }

  #buttons {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
  }

  #status {
    font-weight: bold;
    margin-top: 15px;
  }
</style>
</head>
<body>

  <h1>ðŸ”µ Control Bluetooth ESP32</h1>
  <button onclick="connectBluetooth()">ðŸ”— Conectar / Reconectar</button>
  <div id="status">Desconectado</div>
  <div class="device-info" id="deviceInfo"></div>

  <div id="buttons">
    <button id="led1" class="led-btn" onclick="toggleLED(1)">LED 1 OFF</button>
    <button id="led2" class="led-btn" onclick="toggleLED(2)">LED 2 OFF</button>
    <button id="led3" class="led-btn" onclick="toggleLED(3)">LED 3 OFF</button>
  </div>

<script>
let device, server, service, characteristic;
let ledStates = [false, false, false];

// UUIDs del servicio y caracterÃ­stica BLE
const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';

async function connectBluetooth() {
  try {
    // Intenta reconectarse a un dispositivo previamente emparejado
    const devices = await navigator.bluetooth.getDevices();
    if (devices.length > 0) {
      device = devices[0];
      await device.gatt.connect();
      document.getElementById("status").textContent = "Reconectado a " + device.name;
      setupBluetooth();
      return;
    }

    // Si no hay emparejados, muestra la lista
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "ESP32" }],
      optionalServices: [SERVICE_UUID]
    });

    document.getElementById("status").textContent = "Conectando a " + device.name + "...";
    server = await device.gatt.connect();
    setupBluetooth();

  } catch (error) {
    alert("Error al conectar: " + error);
  }
}

async function setupBluetooth() {
  try {
    service = await device.gatt.getPrimaryService(SERVICE_UUID);
    characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

    document.getElementById("status").textContent = "âœ… Conectado a " + device.name;
    document.getElementById("deviceInfo").textContent = "Listo para enviar comandos.";
  } catch (error) {
    alert("Error al inicializar servicio BLE: " + error);
  }
}

async function toggleLED(num) {
  if (!characteristic) {
    alert("ConÃ©ctate primero al ESP32");
    return;
  }

  ledStates[num - 1] = !ledStates[num - 1];
  const cmd = ledStates[num - 1] ? String.fromCharCode(64 + num) : String.fromCharCode(96 + num);

  await characteristic.writeValue(new TextEncoder().encode(cmd));

  const btn = document.getElementById("led" + num);
  btn.textContent = ledStates[num - 1] ? `LED ${num} ON` : `LED ${num} OFF`;
  btn.classList.toggle("on", ledStates[num - 1]);
}
</script>

</body>
</html>
