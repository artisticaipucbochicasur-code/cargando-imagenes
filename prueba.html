<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control ESP32</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #5ee7df, #b490ca);
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    color: #fff;
    padding: 30px 0;
    box-sizing: border-box;
  }

  h1 {
    font-size: 26px;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  /* --- BOT√ìN BLUETOOTH --- */
  #btButton {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: none;
    background: #4e54c8;
    color: white;
    font-size: 30px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.3s;
    cursor: pointer;
  }
  #btButton.connected {
    background: #00c853;
    box-shadow: 0 0 20px rgba(0,200,83,0.6);
  }
  #btButton:active {
    transform: scale(0.95);
  }

  /* --- CONTENEDOR DE LEDS --- */
  .led-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 25px;
    margin-top: 30px;
  }

  .switch {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: #ffffff22;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    font-weight: 600;
    transition: 0.3s;
    cursor: pointer;
  }

  .switch.on {
    background: #00c853;
    box-shadow: 0 0 20px rgba(0,200,83,0.5);
  }

  .switch i {
    font-size: 28px;
    margin-bottom: 6px;
  }

  /* --- BOTONES DE CONTROL --- */
  .controls {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
  }

  .ctrl-btn {
    background: #ffffff22;
    border: none;
    border-radius: 30px;
    color: white;
    padding: 12px 20px;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: 0.3s;
  }
  .ctrl-btn:hover {
    background: #8f94fb;
    transform: scale(1.05);
  }

  /* --- TOAST MODERNO --- */
  #toast {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(50,50,50,0.9);
    color: white;
    padding: 14px 24px;
    border-radius: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    opacity: 0;
    transition: opacity 0.4s ease, transform 0.4s ease;
    z-index: 999;
  }
  #toast.show {
    opacity: 1;
    transform: translate(-50%, 0);
  }
</style>
</head>
<body>

  <h1>Control de Luces ESP32</h1>

  <!-- BOT√ìN BLUETOOTH -->
  <button id="btButton" onclick="toggleBluetooth()">
    <i class="fa-brands fa-bluetooth-b"></i>
  </button>

  <!-- LEDS -->
  <div class="led-container">
    <div id="led1" class="switch" onclick="toggleLed(1)">
      <i class="fa-regular fa-lightbulb"></i>
      <span>LED 1</span>
    </div>
    <div id="led2" class="switch" onclick="toggleLed(2)">
      <i class="fa-regular fa-lightbulb"></i>
      <span>LED 2</span>
    </div>
    <div id="led3" class="switch" onclick="toggleLed(3)">
      <i class="fa-regular fa-lightbulb"></i>
      <span>LED 3</span>
    </div>
  </div>

  <!-- BOTONES EXTRA -->
  <div class="controls">
    <button class="ctrl-btn" onclick="turnAll(true)">üí° Encender todas</button>
    <button class="ctrl-btn" onclick="turnAll(false)">üåô Apagar todas</button>
  </div>

  <!-- TOAST -->
  <div id="toast"></div>

<script>
let device, server, service, characteristic;
let leds = {1: false, 2: false, 3: false};
let connected = false;

// ---- TOAST ----
function showToast(msg, color="#333") {
  const toast = document.getElementById("toast");
  toast.style.background = color;
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2500);
}

// ---- CONECTAR / DESCONECTAR ----
async function toggleBluetooth() {
  const btn = document.getElementById("btButton");

  if (connected && device?.gatt.connected) {
    device.gatt.disconnect();
    btn.classList.remove("connected");
    showToast("üî¥ Desconectado del ESP32", "#c62828");
    connected = false;
    return;
  }

  try {
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
    });
    server = await device.gatt.connect();
    service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
    characteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
    connected = true;
    btn.classList.add("connected");
    showToast("‚úÖ Conectado a " + device.name, "#00c853");
  } catch (error) {
    showToast("‚ùå Error: " + error.message, "#ff5722");
  }
}

// ---- ENVIAR COMANDOS ----
async function sendCommand(cmd) {
  if (!characteristic) {
    showToast("‚ö†Ô∏è Con√©ctate primero al ESP32", "#ff9800");
    return;
  }
  try {
    const data = new TextEncoder().encode(cmd);
    await characteristic.writeValue(data);
  } catch (error) {
    showToast("‚ùå Error al enviar comando", "#e53935");
  }
}

// ---- TOGGLE LED ----
function toggleLed(num) {
  leds[num] = !leds[num];
  const el = document.getElementById("led" + num);
  const icon = el.querySelector("i");

  if (leds[num]) {
    el.classList.add("on");
    icon.classList.replace("fa-regular", "fa-solid");
  } else {
    el.classList.remove("on");
    icon.classList.replace("fa-solid", "fa-regular");
  }

  const cmd = leds[num] ? String.fromCharCode(64 + num) : String.fromCharCode(96 + num);
  sendCommand(cmd);
}

// ---- ENCENDER / APAGAR TODAS ----
function turnAll(state) {
  for (let i = 1; i <= 3; i++) {
    if (leds[i] !== state) toggleLed(i);
  }
  showToast(state ? "üí° Todas encendidas" : "üåô Todas apagadas");
}
</script>

</body>
</html>
