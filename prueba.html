<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Subir Anuncio</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 30px auto; padding: 20px; background: #f9f9f9; }
    .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input, textarea, button { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; }
    textarea { height: 80px; resize: vertical; }
    button { background: #28a745; color: white; font-weight: bold; cursor: pointer; }
    button:hover { background: #218838; }
    #preview { max-width: 100%; margin: 10px 0; border-radius: 8px; }
    .msg { margin-top: 15px; padding: 12px; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .loading { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>

<div class="card">
  <h2>Subir Anuncio a Drive</h2>
  <form id="formAnuncio">
    <input type="text" id="titulo" placeholder="Título del anuncio" required />
    <textarea id="descripcion" placeholder="Descripción" required></textarea>
    <input type="file" id="imagen" accept="image/jpeg,image/png" required />
    <img id="preview" src="" alt="Vista previa" style="display:none;" />
    <input type="text" id="autor" placeholder="Tu nombre" required />
    <input type="email" id="correo" placeholder="tu@email.com" required />
    <button type="submit">Subir Anuncio</button>
  </form>
  <div id="resultado"></div>
</div>

<script>
  // Vista previa de imagen
  document.getElementById('imagen').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('preview');
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });

  // Enviar formulario
  document.getElementById('formAnuncio').addEventListener('submit', async function(e) {
    e.preventDefault();
    const resultado = document.getElementById('resultado');
    resultado.innerHTML = '<div class="msg loading">Subiendo anuncio...</div>';

    const file = document.getElementById('imagen').files[0];
    if (!file) {
      resultado.innerHTML = '<div class="msg error">Selecciona una imagen.</div>';
      return;
    }

    // Convertir a base64
    const toBase64 = file => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = error => reject(error);
    });

    try {
      const base64 = await toBase64(file);

      const datos = {
        accion: "guardar",
        tipo: "anuncio",
        titulo: document.getElementById('titulo').value.trim(),
        descripcion: document.getElementById('descripcion').value.trim(),
        imagen: base64,
        autor: document.getElementById('autor').value.trim(),
        correo: document.getElementById('correo').value.trim()
      };

      const response = await fetch('https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec', {
        method: 'POST',
        body: JSON.stringify(datos),
        headers: { 'Content-Type': 'application/json' },
        mode: 'cors'
      });

      const text = await response.text();
      let json;
      try {
        json = JSON.parse(text);
      } catch (e) {
        throw new Error("Respuesta no es JSON: " + text);
      }

      if (json.status === "success") {
        // Extraemos la URL de la imagen desde la hoja (columna 3)
        const ultimaFila = SpreadsheetApp.openById("1xp9vXf3mwy8284O59loACSuvG5oz2pNqHMbBm2HHAnI").getSheetByName("Anuncios").getLastRow();
        const urlImagen = SpreadsheetApp.openById("1xp9vXf3mwy8284O59loACSuvG5oz2pNqHMbBm2HHAnI").getSheetByName("Anuncios").getRange(ultimaFila, 3).getValue();

        resultado.innerHTML = `
          <div class="msg success">
            <strong>¡Anuncio guardado!</strong><br>
            ID: ${json.id}<br>
            <a href="${urlImagen}" target="_blank">Ver imagen subida</a>
          </div>`;
      } else {
        resultado.innerHTML = `<div class="msg error">Error: ${json.message || 'Desconocido'}</div>`;
      }

    } catch (err) {
      resultado.innerHTML = `<div class="msg error">Error: ${err.message}</div>`;
      console.error(err);
    }
  });
</script>

</body>
</html>
